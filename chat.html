<html>
  <head>
    <link rel="shortcut icon"href="/starlite-logo.png"type="image/png">
    <title>Starlite | Chat</title>
  </head>
  <div id='wall'></div>
  <script>
    window.setTimeout(function() {
      document.getElementById('wall').style.visibility = 'hidden';
      document.getElementById('animate').style.visibility = 'hidden';
    }, 3000);
 </script>
  <div id="animate">
  </div>
  <style>
    #wall {
      position: fixed;
      background-color: white;
      width: 100%;
      height: 100%;
      top: 0px;
      left: 0px;
      z-index: 100;
    }
    #animate {
      position: absolute;
      left: 50%;
      top: 50%;
      width: 30px;
      height: 30px;
      margin-top:-15px;
      margin-left:-15px;
      border: 1px solid orangered;
      background-color: orangered;
      border-radius: 15px;
      animation: animation 2s infinite;
      z-index:101;
    }
    @keyframes animation {
      0% {
        margin-left: -15px;
        margin-top: -65px;
      }
      25% {
        margin-left: 35px;
        margin-top: -15px;
        background-color: white;
      }
      50% {
        margin-left: -15px;
        margin-top: 35px;
        background-color: orangered;
      }
      75% {
        margin-left: -65px;
        margin-top: -15px;
        background-color: white;
      }
      100% {
        margin-left: -15px;
        margin-top: -65px;
      }
    }
  </style>
  <div id="messages">
  </div>
  <div>
    <textarea placeholder="Message" id="message"></textarea>
    <input type="text" placeholder="To" id="from"/>
    <button id="submit">Send Message</button>
    <h3> How To Use </h3>
    <p><b>Send Message:</b> Type message in MESSAGE box, and a username in TO box.</p>
    <p><b>Send to Everyone:</b> Type public in the TO box.</p>
    <p><b>Send to Muliple People:</b> Type : or colons in between usernames.</p>
  </div>
  <style>
    * {
      font-family: Courier;
    }
    div {
      display: block;
      font-family: Courier;
    }
    textarea {
      margin-bottom: 10px;
      margin-top: 10px;
      width: 200px;
      height: 100px;
      display: block;
      background-color: white;
      font-family: Courier;
      border: 1px solid black;
      padding: 10px;
    }
    input {
      margin-bottom: 10px;
      width: 200px;
      display: block;
      font-family: Courier;
      background-color: white;
      border: 1px solid back;
      padding: 10px;
    }
    button {
      font-family: Courier;
      color: white;
      background-color: orange;
      border: 1px solid orange;
      padding: 5px;
      border-radius: 20px;
    }
  </style>
  <h1>Adam and Chase email me at 3foes@mail.com</h1>
  <iframe src="" id="database" visibility="hidden" display="hidden" width="0" height="0"></iframe>
  <iframe src="" id="database2" visibility="hidden" display="hidden" width="0" height="0"></iframe>
  <script src="https://js.pusher.com/7.0/pusher.min.js"></script>
  <script>
  var database = document.getElementById("database");
  var database2 = document.getElementById("database2");
  var messages, userMessages;
  var pusher = new Pusher('127a8a2ca4a3676b2df9', {
    cluster: 'us2',
    authEndpoint: 'https://DimgreyZigzagProjector--five-nine.repl.co/pusher/auth',
  });
  var chat = pusher.subscribe('private-chat');
  function list(item) {
    var channel = pusher.subscribe('database-return');
    channel.bind('list', function(response) {
      messages = response.data;
      pusher.unsubscribe('database-return');
    });
    database2.src='https://starlitedatabase.cs641311.repl.co/?task=list&item='+item;
  }
  function update(username, key, value) {
    database.src="https://starlitedatabase.cs641311.repl.co/?task=update&username="+username+"&key="+key+"&value="+value;
  }
  function get(username) {
    var channel = pusher.subscribe('database-return');
    channel.bind('get', function(response) {
      userMessages = JSON.parse(response.data[0].messages);
      pusher.unsubscribe('database-return');
    });
    database.src="https://starlitedatabase.cs641311.repl.co/?task=get&username="+username;
  }
  list('messages');
  var d = [], e = [], interval;
  window.setTimeout(function() {
    get(sessionStorage.username);
    interval = window.setInterval(updateChat, 1000);
    chat.bind('client-message', function(data) {
      updateChat(data.data);
    });
  }, 7000);
  var oldMessages = [];
  function updateChat(m) {
    if (m != undefined) {
      messages = messages.concat(m);
    }
    var messageHolder = [];
    if (messages == oldMessages) {
      return null;
    } else {
      console.log(messages.filter(oldMessages));
      newMessages = messages.filter(oldMessages);
    }
    d = [];
    var l = 0;
    while (l<newMessages.length) {
      if (newMessages[l].send == sessionStorage.username || newMessages[l].user == sessionStorage.username || newMessages[l].user == "public" || sessionStorage.username == "admin") {
        var t = document.createElement("DIV");
        t.style = "margin-left:5%;margin-right:44%;margin-bottom:1%;margin-top:1%;padding:1%;border:1px solid black;word-wrap:break-word;width:50%;";
        var data;
        if (sessionStorage.username == newMessages[l].send || sessionStorage.username == "admin") {
          var q = document.createElement("BUTTON");
          t.id = l;
          q.setAttribute("onclick", 'get(messages[JSON.parse(this.parentElement.id)].send); setTimeout(function(){t=userMessages; for(var l=0;l<t.length;l++){if(t[l].message==messages[JSON.parse(this.parentElement.id)].message){t.splice(l, 0);}} update(messages[JSON.parse(this.parentElement.id)].send, "messages", JSON.stringify(t));}.bind(this), 2000);');
          q.innerHTML = "Delete";
          t.innerHTML = q.outerHTML+" "+newMessages[l].send+": <div><b>"+newMessages[l].message+"</b></div>to:"+newMessages[l].user+" at: "+newMessages[l].timestamps;
        } else {
          t.innerHTML = newMessages[l].send+": <b>"+newMessages[l].message+"</b> to: "+newMessages[l].user+" at: "+newMessages[l].timestamps;
        } 
        e.push(t);
        d.push(t);
        document.getElementById("messages").appendChild(t);
        
      } 
      l++;
    }
    oldMessages = messages;
  }
  document.getElementById("submit").addEventListener("click", send);
  function send() {
    if (document.getElementById("from").value!=""&&document.getElementById("message").value!="") {
      var m = document.getElementById("message").value;
      if (m.replace(/\s/g,'').toLowerCase().includes("damn") || m.replace(/\s/g,'').toLowerCase().includes("shit") || m.replace(/\s/g,'').toLowerCase().includes("fuck") || m.replace(/\s/g,'').toLowerCase().includes("ass") || m.replace(/\s/g,'').toLowerCase().includes("bitch") || m.replace(/\s/g,'').toLowerCase().includes("cunt")) { // CHASE Put in the 'words' in the includes("<here>") area (delete this after you do it)
        alert("Cuss Word Detected! We do not permit any cuss words. If you disagree that you have not cuss words in your message report to 'admin' in chat");
      } else {
        chat.trigger('client-message', {data:{message:document.getElementById("message").value,user:document.getElementById("from").value,send:sessionStorage.username,timestamps:new Date()}});
        get(sessionStorage.username);
        setTimeout(function() {
          update(sessionStorage.username, 'messages', JSON.stringify(userMessages.concat({message:document.getElementById("message").value,user:document.getElementById("from").value,send:sessionStorage.username,timestamps:new Date()})));
          updateChat({message:document.getElementById("message").value,user:document.getElementById('from').value,send:sessionStorage.username,timestamps:new Date()});       
          document.getElementById("message").value = "";
          document.getElementById("from").value = "";
        }, 2000);
      }
      
    }
  }
  </script>
</html>
